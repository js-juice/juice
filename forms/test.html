<!doctype html>
<html>

    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <title>Input components demo</title>
        <script type="module" src="./juice-forms-setup.mjs"></script>
        <script type="module" src="./juice-forms.mjs"></script>

        <style>
            body {
                font-family: system-ui, Segoe UI, Roboto, Arial, sans-serif;
                padding: 1rem;
                font-size: 16px;
            }

            form {

                max-width: 40rem;
                font-size: 1em
            }

            form .fields {
                display: flex;
                flex-direction: row;
                flex-wrap: wrap;
                gap: 1rem;
                max-width: 40rem;
                font-size: 1em
            }

            form .fields>* {
                flex: 0 1 auto;
            }

            form .fields>.row {
                display: flex;
                flex-direction: row;
                gap: 1rem;
                flex: 1 1 100%;
                width: 100%;
            }

            form .fields>.row>* {
                flex: 0 1 auto;

            }

            form .fields>.row.half {
                display: grid;
                grid-template-columns: repeat(2, minmax(0, 1fr));
                gap: 1rem;
                width: 100%;
            }

            form .fields>.row.half>* {
                min-width: 0;
            }

            form .fields>.row.thirds {
                display: grid;
                grid-template-columns: repeat(3, minmax(0, 1fr));
                gap: 1rem;
                width: 100%;
            }

            form .fields>.row.thirds>* {
                min-width: 0;
            }

            .static {
                flex: 0 0 auto !important;
                width: auto !important;
            }

            .w\:100 {
                width: 100% !important;
            }

            .w\:75 {
                width: 75% !important;
            }

            .w\:50 {
                width: 50% !important;
            }

            .w\:25 {
                width: 25% !important;
            }
        </style>
    </head>

    <body>
        <h1>Custom Input Components Demo</h1>
        <form id="demoForm">


            <form id="demo-form">
                <form-info id="formInfoDemo" for="demo-form">
                    Make changes to the form above. Undo/Revert actions appear when history has steps.
                </form-info>
                <div class="fields">
                    <input-text name="username" label="Username" placeholder="Type name" required
                        validation="min:3|max:20|a-z0-9"></input-text>

                    <input-text name="password" label="Password" placeholder="Type password" required
                        validation="min:8|max:20|a-z0-9"></input-text>
                </div>
            </form>


            <form id="test-form" method="POST" action="/submit">
                <form-info id="formInfoDemo" for="test-form">
                    Make changes to the form above. Undo/Revert actions appear when history has steps.
                </form-info>
                <div class="fields">

                    <div class="row thirds">
                        <input-text name="firstname" label="First Name" placeholder="Type first name" required
                            validation="min:3|max:20|a-z0-9"></input-text>
                        <input-text name="middlename" label="Middle Name" placeholder="Type middle name" required
                            validation="min:3|max:20|a-z0-9"></input-text>
                        <input-text name="lastname" label="Last Name" placeholder="Type last name" required
                            validation="min:3|max:20|a-z0-9"></input-text>

                    </div>

                    <div class="row">
                        <input-text class="w:75" name="address_line1" label="Address Line 1" placeholder="Type address"
                            required validation="min:3|max:20|a-z0-9"></input-text>
                        <input-text class="" name="address_unit" label="Apt/Unit" placeholder="Apt/Unit #" required
                            validation="min:3|max:20|a-z0-9"></input-text>
                    </div>
                    <div class="row thirds">
                        <input-text class="w:100" name="city" label="City" placeholder="Type city" required
                            validation="min:3|max:20|a-z0-9"></input-text>
                        <input-select name="state" label="State" required
                            options="ny:New York, ca:California, tx:Texas">
                            <option value="" selected>Select State</option>
                            <option value="ak">Alaska</option>
                            <option value="ny">New York</option>
                            <option value="ca">California</option>
                            <option value="tx">Texas</option>
                        </input-select>
                        <input-text class="static" name="zip" label="ZIP Code" placeholder="00000-0000" maxlength="10"
                            required validation="min:5|max:9" format="ddddd-dddd"></input-text>
                    </div>
                    <option-group label="Preferences">
                        <input-checkbox name="pref_email" label="Email Notifications" value="yes"></input-checkbox>
                        <input-checkbox name="pref_sms" label="SMS Notifications" value="yes"></input-checkbox>
                        <input-checkbox name="pref_push" label="Push Notifications" value="yes"></input-checkbox>
                    </option-group>


                    <input-textarea name="bio" label="Bio" placeholder="Write something about yourself" required
                        validation="min:10|max:200"></input-textarea>

                    <div>
                        <input-checkbox name="subscribe" label="Subscribe" value="yes"></input-checkbox>
                    </div>
                    <div>
                        <input-select name="country" label="Country"
                            options="usa:USA:selected, canada:Canada, mexico:Mexico"></input-select>
                    </div>
                    <div>
                        <input-radio name="color" label="Red" value="red"></input-radio>
                        <input-radio name="color" label="Green" value="green"></input-radio>
                        <input-radio name="color" label="Blue" value="blue"></input-radio>
                    </div>

                </div>
            </form>
            <button type="button" id="dump">Dump values</button>
        </form>

        <pre id="out"></pre>
        <hr />
        <h2>Input Status Demo</h2>
        <div style="display:flex;align-items:center;gap:1.25rem;flex-wrap:wrap;">
            <div id="statusPreviewWrap"
                style="display:flex;align-items:center;gap:0.5rem;padding:0.4rem 0.6rem;border-radius:0.5rem;background:transparent;transition:background-color .2s ease;">
                <input-status id="statusDemo" size="42" state="idle"></input-status>
                <span>default</span>
            </div>
            <div style="display:flex;align-items:center;gap:0.5rem;flex-wrap:wrap;">
                <button type="button" data-status-mode="default">Default</button>
                <button type="button" data-status-mode="icon-only-colored">Icon Only Colored</button>
            </div>
            <div style="display:flex;align-items:center;gap:0.5rem;flex-wrap:wrap;">
                <button type="button" data-status-surface="light">Light Surface</button>
                <button type="button" data-status-surface="dark">Dark Surface</button>
            </div>
            <button type="button" id="cycleStatus">Cycle Status</button>
            <span id="statusLabel">idle | mode: default</span>
        </div>
        <hr />
        <h2>Form Info Demo</h2>
        <div style="display:flex;flex-direction:column;gap:0.75rem;max-width:40rem;">
            <form-info id="formInfoDemo" for="demoForm">
                Make changes to the form above. Undo/Revert actions appear when history has steps.
            </form-info>
        </div>

        <script>
            document.getElementById('dump').addEventListener('click', () => {
                const form = document.getElementById('demoForm');
                const out = {};
                const fields = form.querySelectorAll(
                    'input-text,input-textarea,input-select,input-number,input-checkbox,input-radio'
                );

                fields.forEach((field) => {
                    const name = field.getAttribute('name');
                    if (!name) return;

                    const tag = field.tagName.toLowerCase();
                    if (tag === 'input-checkbox') {
                        out[name] = !!field.checked;
                        return;
                    }

                    if (tag === 'input-radio') {
                        if (!(name in out)) out[name] = null;
                        if (field.checked) out[name] = field.value;
                        return;
                    }

                    out[name] = field.value;
                });

                document.getElementById('out').textContent = JSON.stringify(out, null, 2);
            });

            const statusStates = ['idle', 'info', 'warning', 'error', 'success'];
            const statusEl = document.getElementById('statusDemo');
            const statusLabel = document.getElementById('statusLabel');
            const statusPreviewWrap = document.getElementById('statusPreviewWrap');
            const modeButtons = document.querySelectorAll('[data-status-mode]');
            const surfaceButtons = document.querySelectorAll('[data-status-surface]');
            let statusIndex = 0;
            let statusMode = 'default';
            let statusSurface = 'neutral';

            function applyMode(mode) {
                statusMode = mode;
                statusEl.removeAttribute('icon-only');
                statusEl.removeAttribute('colored');
                statusPreviewWrap.style.backgroundColor = 'transparent';
                statusPreviewWrap.style.color = 'inherit';

                if (mode === 'icon-only') {
                    statusEl.setAttribute('icon-only', '');
                } else if (mode === 'icon-only-colored') {
                    statusEl.setAttribute('icon-only', '');
                    statusEl.setAttribute('colored', '');
                    statusSurface = 'neutral';
                } else if (mode === 'default') {
                    statusSurface = 'neutral';
                }

                if (statusSurface === 'dark') {
                    statusPreviewWrap.style.backgroundColor = '#2f2f33';
                    statusPreviewWrap.style.color = '#f3f3f3';
                } else if (statusSurface === 'light') {
                    statusPreviewWrap.style.backgroundColor = '#f6f6f6';
                    statusPreviewWrap.style.color = '#222222';
                } else {
                    statusPreviewWrap.style.backgroundColor = 'transparent';
                    statusPreviewWrap.style.color = 'inherit';
                }
            }

            function applySurface(surface) {
                statusSurface = surface;
                statusMode = 'icon-only';
                statusEl.removeAttribute('colored');
                statusEl.setAttribute('icon-only', '');
                if (surface === 'dark') {
                    statusPreviewWrap.style.backgroundColor = '#2f2f33';
                    statusPreviewWrap.style.color = '#f3f3f3';
                } else {
                    statusPreviewWrap.style.backgroundColor = '#f6f6f6';
                    statusPreviewWrap.style.color = '#222222';
                }
            }

            function updateStatusLabel(state) {
                statusLabel.textContent = `${state} | mode: ${statusMode} | surface: ${statusSurface}`;
            }

            modeButtons.forEach((btn) => {
                btn.addEventListener('click', () => {
                    applyMode(btn.getAttribute('data-status-mode'));
                    updateStatusLabel(statusStates[statusIndex]);
                });
            });

            surfaceButtons.forEach((btn) => {
                btn.addEventListener('click', () => {
                    applySurface(btn.getAttribute('data-status-surface'));
                    updateStatusLabel(statusStates[statusIndex]);
                });
            });

            applyMode('default');

            document.getElementById('cycleStatus').addEventListener('click', () => {
                statusIndex = (statusIndex + 1) % statusStates.length;
                const state = statusStates[statusIndex];
                statusEl.setAttribute('state', state);
                updateStatusLabel(state);
            });

            setInterval(() => {
                statusIndex = (statusIndex + 1) % statusStates.length;
                const state = statusStates[statusIndex];
                statusEl.setAttribute('state', state);
                updateStatusLabel(state);
            }, 3000);

            async function setupFormInfoHistoryDemo() {
                await customElements.whenDefined('form-info');

                const formInfoEl = document.getElementById('formInfoDemo');
                const formEl = document.getElementById('demoForm');
                if (!formInfoEl || !formEl || typeof formInfoEl.bindForm !== 'function') return;

                const formFields = Array.from(
                    formEl.querySelectorAll(
                        'input-text,input-checkbox,input-select,input-number,input-radio,input-textarea'
                    )
                );

                function captureSnapshot() {
                    return formFields.map((field, index) => ({
                        index,
                        value: field.value,
                        checked: 'checked' in field ? !!field.checked : null
                    }));
                }

                function snapshotsEqual(a, b) {
                    if (!Array.isArray(a) || !Array.isArray(b) || a.length !== b.length) return false;
                    for (let i = 0; i < a.length; i += 1) {
                        if (a[i].value !== b[i].value || a[i].checked !== b[i].checked) {
                            return false;
                        }
                    }
                    return true;
                }

                let isApplyingSnapshot = false;
                let lastSnapshot = captureSnapshot();

                function applySnapshot(snapshot) {
                    if (!Array.isArray(snapshot)) return;
                    isApplyingSnapshot = true;
                    snapshot.forEach((entry) => {
                        const field = formFields[entry.index];
                        if (!field) return;
                        if ('checked' in field) field.checked = !!entry.checked;
                        if (field.value !== entry.value) field.value = entry.value;
                    });
                    isApplyingSnapshot = false;
                }

                const historyListeners = {
                    notEmpty: [],
                    empty: []
                };

                const demoHistory = {
                    stack: [],
                    on(event, fn) {
                        if (!historyListeners[event]) return;
                        historyListeners[event].push(fn);
                    },
                    emit(event) {
                        if (!historyListeners[event]) return;
                        historyListeners[event].forEach((fn) => fn());
                    },
                    push(snapshot) {
                        if (!Array.isArray(snapshot)) return;
                        this.stack.push(snapshot);
                        if (this.stack.length === 1) this.emit('notEmpty');
                    },
                    undo() {
                        if (!this.stack.length) return;
                        applySnapshot(this.stack.pop());
                        lastSnapshot = captureSnapshot();
                        if (!this.stack.length) this.emit('empty');
                    },
                    reset() {
                        this.stack = [];
                        this.emit('empty');
                    }
                };

                const demoFormAdapter = {
                    form: formEl,
                    default: captureSnapshot(),
                    history: demoHistory,
                    undo() {
                        this.history.undo();
                    },
                    fill(snapshot) {
                        applySnapshot(snapshot);
                        lastSnapshot = captureSnapshot();
                    }
                };

                formInfoEl.bindForm(demoFormAdapter);
                formInfoEl.setAttribute('message', 'History is enabled for this demo form.');

                formFields.forEach((field) => {
                    field.addEventListener('input', () => {
                        if (isApplyingSnapshot) return;
                        const nextSnapshot = captureSnapshot();
                        if (!snapshotsEqual(nextSnapshot, lastSnapshot)) {
                            demoHistory.push(lastSnapshot);
                            lastSnapshot = nextSnapshot;
                        }
                    });
                });
            }

            setupFormInfoHistoryDemo();
        </script>
    </body>

</html>
